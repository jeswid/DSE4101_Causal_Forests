---
title: "DSE4101 Group project"
author: "o'rianna"
date: "2025-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("devtools")
library(devtools) 
#install_github("susanathey/causalTree")
#install.packages("grf")
#install.packages("caret")
library(causalTree) 
library(grf)
library(caret)
#install.packages("FNN")
library(FNN)
library(parallel)
#install.packages("BART") 
library(BART)
#install.packages("dplyr")
library(drgee)
library(dplyr)
```

## BART

```{r}

# Train separate BART models for treated and control groups
treated_train <- train_data[train_data$T == 1, ] # Subset for treated group (T = 1)
bart_treated <- wbart(x.train = treated_train[, -c(1,2)], y.train = treated_train$Y) # Train BART on treated group

control_train <- train_data[train_data$T == 0, ] # Subset for control group (T = 0)
bart_control <- wbart(x.train = control_train[, -c(1,2)], y.train = control_train$Y) # Train BART on control group

# Predict potential outcomes for test set
Y1_hat_test <- predict(bart_treated, newdata = test_data[, -c(1,2)])  # Predicted Y if treated
Y0_hat_test <- predict(bart_control, newdata = test_data[, -c(1,2)])  # Predicted Y if control

# Compute estimated Individual Treatment Effects (ITE)
tau_hat_test <- rowMeans(Y1_hat_test) - rowMeans(Y0_hat_test)

# Bin test data based on X1 for CATE estimation
num_bins <- 10  # Number of bins
X1_bins_test <- cut(test_data$X1, breaks = num_bins, labels = FALSE)

# Convert to a data frame for aggregation
df_test_cate <- data.frame(X1_bins_test, tau_hat_test, true_tau = true_tau[-train_i])

# Compute average estimated and true CATE in each bin
CATE_estimates_test <- aggregate(tau_hat_test ~ X1_bins_test, data = df_test_cate, FUN = mean)$tau_hat_test
CATE_true_test <- aggregate(true_tau ~ X1_bins_test, data = df_test_cate, FUN = mean)$true_tau

# Compute RMSE of CATE estimates
CATE_rmse_test <- sqrt(mean((CATE_estimates_test - CATE_true_test)^2, na.rm = TRUE))
CATE_rmse_test
```


## Causal KNN

```{r}
causal_knn <- function(X, T, Y, k) {
  n <- nrow(X)
  tau_hat <- numeric(n)  # Store estimated CATE for each observation
  
  for (i in 1:n) {
    # Find k nearest neighbors
    neighbors <- knnx.index(X, query = matrix(X[i, ], nrow = 1), k = k)
    
    # Extract neighbors' treatment and outcome values
    Y_neighbors <- Y[neighbors]
    T_neighbors <- T[neighbors]
    
    # Compute local averages for treated and control groups
    Y1_hat <- mean(Y_neighbors[T_neighbors == 1], na.rm = TRUE)
    Y0_hat <- mean(Y_neighbors[T_neighbors == 0], na.rm = TRUE)
    
    # Estimate CATE
    tau_hat[i] <- Y1_hat - Y0_hat
  }
  
  return(tau_hat)
}

# Compute Estimated CATE for Each Observation
k <- 10  # Number of neighbors
tau_knn <- causal_knn(X, T, Y, k)

# Replace any NA values in tau_knn with 0
tau_knn[is.na(tau_knn)] <- 0

# Compute RMSE to Compare tau_knn with true_tau
rmse_knn <- sqrt(mean((tau_knn - true_tau)^2))
rmse_knn
```

## AIPW
```{r}
# Fit the AIPW model using drgee
covariate_names <- paste0("X", 1:p)  # Create a vector of covariate names, X1, X2, ..., Xp
covariate_formula <- paste(covariate_names, collapse = " + ")  # Combine names into a formula string

# Fit the AIPW model using drgee with correct formula syntax
aipw_model_train <- drgee(
  oformula = as.formula(paste("Y ~", covariate_formula)),  # Outcome model with covariates
  eformula = as.formula(paste("T ~", covariate_formula)),  # Treatment model with covariates
  elink = "logit",  # Logistic link function for the treatment model
  data = train_data  # Data containing all the variables
)
summary(aipw_model_train)
aipw_model_train$coefficients.all

aipw_model_test <- drgee(
  oformula = as.formula(paste("Y ~", covariate_formula)),  # Outcome model with covariates
  eformula = as.formula(paste("T ~", covariate_formula)),  # Treatment model with covariates
  elink = "logit",  # Logistic link function for the treatment model
  data = test_data  # Data containing all the variables
)
summary(aipw_model_test)
aipw_model_test$coefficients.all

cat("Estimated CATE (Train):", aipw_model_train$coefficients, "\n")
cat("Estimated CATE (Test):", aipw_model_test$coefficients, "\n")

# Compute RMSE
RMSE_AIPW <- sqrt(mean((aipw_model_train$coefficients.all - aipw_model_test$coefficients.all)^2, na.rm = TRUE))
print(paste("RMSE:", round(RMSE_AIPW, 5)))
```

## Causal Trees

```{r}
# Train Causal Tree
formula1 <- as.formula(paste("Y ~", paste(colnames(as.data.frame(X_train)), collapse = ' + ')))

causal_tree <- causalTree(
  formula = formula1,
  data = data.frame(Y = Y_train,X_train),
  treatment = T_train,
  split.Rule = "CT",  # Use Causal Tree splitting rule
  split.Honest = TRUE,
  cv.option = "CT",  # Honest cross-validation
  split.alpha = 1, 
  cv.Honest = TRUE,
  split.Bucket = TRUE,
  bucketNum = 5,
  bucketMax = 100,
  minsize = 100
)

# Honest Estimation
honest_tree <- honest.causalTree(
  formula = formula1,
  data = data.frame(Y=Y_train, X_train),
  treatment = T_train,
  est_data = data.frame(Y = Y_test, X_test),
  est_treatment = T_test,  
  split.alpha = 0.5,
  split.Rule = "CT",
  split.Honest = TRUE,
  cv.alpha = 0.5,
  cv.option = "CT",
  cv.Honest = TRUE,
  split.Bucket = TRUE,
  bucketNum = 5,
  bucketMax = 100, # maximum number of buckets
  minsize = 100
)

# Predict Treatment Effects
CATE_preds_honestTree <- predict(honest_tree, newdata = data.frame(Y = Y_test, X_test), type = "vector")

plot(CATE_preds_honestTree)
```


## Causal Forests

```{r}
# Train Causal Forest
causal_forest1 <- causal_forest(
  X = X_train, 
  Y = Y_train, 
  W = T_train
)

# Predict Treatment Effects
preds <- predict(causal_forest1, X_test)$predictions
hist(preds)

#CATE estimates
CATE_ALL_CF = average_treatment_effect(causal_forest1, target.sample = "all")
average_treatment_effect(causal_forest1, target.sample = "treated")
                                     

```

## MSE and RMSE

```{r}
prop_score <- mean(T_test)

# Construct Y_star in our test sample
Y_star <- T_test * (Y_test / prop_score) - (1 - T_test) * (Y_test / (1 - prop_score))


# Honest Tree
MSE_causalTree <- mean((Y_star - CATE_preds_honestTree)^2)

# Causal Forest GRF
MSE_cf <- mean((Y_star - CATE_ALL_CF)^2)

MSE_causalTree
MSE_cf

RMSE_causalTree = sqrt(MSE_causalTree)
RMSE_cf = sqrt(MSE_cf)

RMSE_causalTree
RMSE_cf
```



